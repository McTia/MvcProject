(function(n){"use strict";n.fn.EditableRender={date:function(t){if(t===null)return"";var i=new Date(parseInt(t.substr(6))),r=new Date(i-i.getTimezoneOffset()*6e4);return t.charAt(0)==="/"?n.fn.datepicker.DPGlobal.formatDate(r,n.fn.datepicker.defaults.format,n.fn.datepicker.defaults.language):t},check:function(n,t){return t==="display"?n===null?"":"<label class='cr-styled'><i class='fa"+(n===!1?"":" fa-check checked")+"'><\/i><\/label>":n},singlefile:function(n,t){var r=n!=null&&n instanceof Object,i=r?n.name:"";return(i.length>16&&(i=i.substring(0,3)+"..."+i.substr(-10)),t==="display")?n?'<a class="btn btn-purple btn-sm fileinput-button" href="/Dynamic/File/'+(r?n.refID:n)+'" download><i class="zmdi zmdi-download"><\/i> '+i+"<\/a>":"":n}};n.fn.EditableEditor={"default":function(t,i,r){var u=n('<input type="text" class="form-control input-block" name="'+t+'"/>');i&&u.val(i);r.html(u)},date:function(t,i,r){var u=n('<input type="text" name="'+t+'" class="form-control" >');i&&u.val(i);n('<div class="input-group"/>').append(u,'<span class="input-group-addon"><i class="glyphicon glyphicon-calendar" ><\/i><\/span>').appendTo(r.empty());u.datepicker()}};n.fn.EditableTable=function(t,i){var u=n.extend(!0,{},n.fn.EditableTable.defaults,{addButton:{wrapper:null,buttonIndex:0},rowActions:{}},i);u.tableOption=n.extend({processing:!0,serverSide:!0,deferRender:!0,rowId:"Id"},t);var r={$table:n(this),$form:n(this).closest("form"),modalAction:null},e={add:function(n){if(u.rowActions.add)return u.rowActions.add(n);var t=r.datatable.columns().flatten().map(function(){return""});return t[t.length-1]=n.join(" "),t}},f={initialize:function(){return this.setVars().build().events()},setVars:function(){return u.tableOption.columnDefs||(u.tableOption.columnDefs=[]),u.tableOption.columnDefs.push({targets:-1,orderable:!1,createdCell:function(t){n(t).addClass("actions").html(u.rowButtons.join(" "))}}),u.tableOption.initComplete=function(){n.fn.dataTable.defaults.oLanguage!=null?setTimeout(function(){f.tableInitComplete()},10):f.tableInitComplete()},u.rowButtons||(u.rowButtons=[u.rowButton.save,u.rowButton.cancel,u.rowButton.edit,u.rowButton.remove]),r.dialog={},r.dialog.$wrapper=n(u.dialog.wrapper),r.dialog.$cancel=n(u.dialog.cancelButton),r.dialog.$confirm=n(u.dialog.confirmButton),r.$table,r.datatable,r.dataSrc,r.dataSrcByIndex,r.$addmodal,r.$addButton,r.modalAction,r.$row,r.rowid,this},build:function(){return r.datatable=r.$table.DataTable(u.tableOption),r.dataSrc=r.datatable.settings().columns().dataSrc(),r.dataSrcByIndex=n.isNumeric(r.dataSrc[0]),r.dataSrcByIndex&&(r.dataSrc=r.datatable.columns().header().map(function(n){return jQuery.data(n,"name")})),this},tableInitComplete:function(){if(u.tableOption.serverSide)if(r.$addButton=u.addButton.wrapper?n(u.addButton.wrapper):r.datatable.button(u.addButton.buttonIndex).to$(),!u.modal.wrapper&&u.addButton.wrapper?r.$addmodal=n(u.addButton.wrapper+"-modal"):u.modal.wrapper&&(r.$addmodal=n(u.modal.wrapper)),r.$addmodal.find(u.modal.confirmButton).click(this.modalClick),u.addButton.wrapper)r.$addButton.on("click",f.addClick);else r.datatable.button(u.addButton.buttonIndex).action(f.addClick);else r.$addButton.on("click",f.addClick)},events:function(){var t=this;r.$table.on("click","a.save-row",function(i){i.preventDefault();t.rowSave(n(this).closest("tr"))}).on("click","a.cancel-row",function(i){i.preventDefault();t.rowCancel(n(this).closest("tr"))}).on("click","a.edit-row",function(i){i.preventDefault();u.editType=="inline"?t.rowEdit(n(this).closest("tr")):t.rowEditModal(n(this).closest("tr"))}).on("click","a.remove-row",function(i){i.preventDefault();var f=n(this).closest("tr");n.magnificPopup.open({items:{src:u.dialog.wrapper,type:"inline"},preloader:!1,modal:!0,callbacks:{change:function(){r.dialog.$confirm.on("click",function(i){i.preventDefault();t.rowRemove(f);n.magnificPopup.close()})},close:function(){r.dialog.$confirm.off("click")}}})});r.dialog.$cancel.on("click",function(t){t.preventDefault();n.magnificPopup.close()});return this},addClick:function(n){n.preventDefault();u.tableOption.serverSide?f.rowAddModal():f.rowAdd()},modalClick:function(){var i=r.$addmodal.closest("form"),t;(!n.isFunction(i.valid)||i.valid())&&(t=r.$addmodal.find(":input").serialize(),r.modalAction==="update"&&(t+="&"+u.tableOption.rowId+"="+r.rowid),f.callAjax(r.modalAction,t,function(n){n.errors?f.rowError(null,r.modalAction,n.errors):(r.datatable.draw(),r.$addmodal.modal("hide"))}))},dataValue:function(n,t){return r.dataSrcByIndex?n[t]:n[r.dataSrc[t]]},rowAddModal:function(){var n,t,i,u;for(r.modalAction="create",n=r.$addmodal,n.find("#rh-action").text(r.modalAction),n.closest("form")[0].reset(),t=0;t<r.dataSrc.length-1;t++)(i=r.dataSrc[t],i)&&(u=r.$addmodal.find('[name="'+i+'"]'),u.trigger("reset"));n.find(".select2-hidden-accessible").trigger("change");n.modal("show")},rowAdd:function(){r.$addButton.attr({disabled:"disabled"});var n,t;n=r.datatable.row.add(e.add(u.rowButtons));t=r.datatable.row(n[0]).nodes().to$();this.rowEdit(t);r.datatable.order([0,"asc"]).draw()},rowCancel:function(t){var i=this,u;t.hasClass("adding")?this.rowRemove(t):(u=r.datatable.row(t.get(0)).data(),t.children("td").each(function(r){var f=n(this);f.hasClass("actions")?(i.rowSetActionsDefault(t),f.find("input[type=hidden]").prop("disabled",!0)):f.html(i.dataValue(u,r))}),r.$row=null)},rowEditModal:function(n){var e=this,i,t,s;for(i=r.datatable.row(n.get(0)).data(),r.rowid=e.dataValue(i,i.length-1),r.modalAction="update",r.$addmodal.find("#rh-action").text(r.modalAction),t=0;t<i.length-1;t++){var o=r.dataSrc[t],f=e.dataValue(i,t),h=f!==null&&f instanceof Object;(h||r.$addmodal.find("#rh-index"+t).text(f),o)&&(s=r.$addmodal.find('[name="'+o+'"]'),u.modal.binder.call(e,t,o,f,s)&&s.trigger("change",f))}r.$addmodal.modal("show")},rowEdit:function(t){r.$row&&this.rowCancel(r.$row);r.$row=t;var i=this,u,f;u=r.datatable.row(t.get(0)).data();f=r.datatable.columns().header();t.children("td").each(function(e){var h=n(this),c,o,s,l;h.hasClass("actions")?i.rowSetActionsEditing(t):(o=r.dataSrc[e],s=n(f[e]).data("type")||"default",o&&s!=="fixed"&&(l=i.dataValue(u,e),(c=n.fn.EditableEditor[s])&&c(o,l,h)))})},rowSave:function(n){var e=this,t,i;n.hasClass("adding")&&(r.$addButton.removeAttr("disabled"),n.removeClass("adding"));t=r.datatable.row(n.get(0)).data();i=e.dataValue(t,t.length-1);this.callAjax("update",r.$form.serialize()+"&"+u.tableOption.rowId+"="+i,function(t){t.errors?f.rowError(n,"update",t.errors):r.datatable.draw()})},callAjax:function(t,i,u){n.ajax({type:r.$form.attr("method"),url:r.$form.attr("action")+"?m="+t,data:i}).done(u).fail(function(n,t,i){alert("STATUS:"+n.status+" "+i)})},rowRemove:function(n){var e=this,t,i;n.hasClass("adding")&&r.$addButton.removeAttr("disabled");t=r.datatable.row(n.get(0)).data();i=e.dataValue(t,t.length-1);this.callAjax("delete",u.tableOption.rowId+"="+i,function(t){t.errors?f.rowError(n,"delete",t.errors):r.datatable.draw()})},rowError:function(t,i,r){n.magnificPopup.open({items:{src:'<div id="dialog" class="modal-block"><section class="panel panel-danger panel-color"><div class="panel-heading"><h2 class="panel-title">Error<\/h2><\/div><div class="panel-body"><div class="modal-wrapper"><div class="modal-text"><ul>'+r.map(function(t){return n("<li>",{text:t}).html()}).join("")+"<\/ul><\/div><\/div><\/div><\/section><\/div>",type:"inline"}})},rowSetActionsEditing:function(n){n.find(".on-editing").removeClass("hidden");n.find(".on-default").addClass("hidden")},rowSetActionsDefault:function(n){n.find(".on-editing").addClass("hidden");n.find(".on-default").removeClass("hidden")}};return f.initialize()};n.fn.EditableTable.defaults={rowButton:{save:'<a href="#" class="hidden on-editing save-row"><i class="fa fa-save"><\/i><\/a>',cancel:'<a href="#" class="hidden on-editing cancel-row"><i class="fa fa-times"><\/i><\/a>',edit:'<a href="#" class="on-default edit-row"><i class="fa fa-pencil"><\/i><\/a>',remove:'<a href="#" class="on-default remove-row"><i class="fa fa-trash-o"><\/i><\/a>'},dialog:{wrapper:"#dialog",cancelButton:"#dialogCancel",confirmButton:"#dialogConfirm"},modal:{wrapper:"#addToTable-modal",confirmButton:"button.btn-info",binder:function(n,t,i,r){if(r.is(":checkbox"))return r.prop("checked",i),!0;var f=r.val(),u=i;return i instanceof Object&&i.refID&&(u=i.refID),r.val(u),r.data("datepicker")&&r.datepicker("update"),f!==u}},editType:"inline"};n.fn.EditableTable.AddButton={text:function(n){return n.i18n("buttons.add","Add")},className:"add"}})(jQuery);